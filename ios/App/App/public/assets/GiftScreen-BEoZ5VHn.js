import{u as Q,I as O,J as n,l as T,j as e,n as V}from"./index-CvGLKNdl.js";import{r as l}from"./chart-vendor-BKK2UjWf.js";import"./react-vendor-OvXVS5lI.js";import"./ai-vendor-9LcfXvm6.js";function te({onBack:K}){const{t}=Q(),[w,U]=l.useState(""),[v,Z]=l.useState(!0),[h,k]=l.useState(null),[I,$]=l.useState(!1),[E,G]=l.useState(!1),[x,j]=l.useState([]),[q,F]=l.useState([]),[u,R]=l.useState(1350),[b,Y]=l.useState("people"),[N,B]=l.useState(1),[H,g]=l.useState(null),[m,c]=l.useState(""),D=1350;l.useEffect(()=>{J(),M()},[]);const J=async()=>{try{if(!O()){k({totalAmount:5e4,newUserCount:20,discountPerUser:2500});return}const s=new Date,a=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,o=new Date(s.getFullYear(),s.getMonth(),1).toISOString().split("T")[0],{data:_,error:p}=await n.from("gifts").select("amount").eq("month",a);if(p)throw p;const S=_?.reduce((L,C)=>L+C.amount,0)||0,{data:P,error:i}=await n.from("user_profiles").select("id").gte("created_at",o+"T00:00:00.000Z").lt("created_at",new Date(s.getFullYear(),s.getMonth()+1,1).toISOString().split("T")[0]+"T00:00:00.000Z");if(i)throw i;const d=P?.length||0,A=d>0?Math.floor(S/d):0;k({totalAmount:S,newUserCount:d,discountPerUser:A})}catch{k({totalAmount:5e4,newUserCount:20,discountPerUser:2500})}},M=async()=>{try{if(!O()){const i=[{id:"m1",message:"ã‚«ãƒ¼ãƒ‹ãƒœã‚¢ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚’å§‹ã‚ã‚‹ã‚ãªãŸã‚’å¿œæ´ã—ã¦ã„ã¾ã™ï¼ä¸€ç·’ã«å¥åº·ãªä½“ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼",isPublic:!0,createdAt:new Date(Date.now()-432e6).toISOString(),userId:"local",likes:12,replies:[{id:"r1",messageId:"m1",userId:"user2",replyText:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é ‘å¼µã‚Šã¾ã™ï¼",createdAt:new Date(Date.now()-3456e5).toISOString()}],userLiked:!1},{id:"m2",message:"åˆæœˆã¯å¤§å¤‰ã§ã™ãŒã€ä¹—ã‚Šè¶Šãˆã‚Œã°ç´ æ™´ã‚‰ã—ã„ä¸–ç•ŒãŒå¾…ã£ã¦ã„ã¾ã™ã€‚",isPublic:!1,createdAt:new Date(Date.now()-2592e5).toISOString(),userId:"local",likes:0,replies:[],userLiked:!1}],d=[{id:"p1",message:"ã‚ˆã†ã“ãï¼ä¸€ç·’ã«å¥åº·ã«ãªã‚Šã¾ã—ã‚‡ã†ï¼",isPublic:!0,createdAt:new Date(Date.now()-14400*60*1e3).toISOString(),userId:"user1",likes:25,replies:[{id:"r2",messageId:"p1",userId:"user3",replyText:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼",createdAt:new Date(Date.now()-12960*60*1e3).toISOString()}],userLiked:!0},{id:"p2",message:"è‚‰ã¯æœ€é«˜ã®è–¬ã§ã™ã€‚",isPublic:!0,createdAt:new Date(Date.now()-11520*60*1e3).toISOString(),userId:"user2",likes:18,replies:[],userLiked:!1},{id:"p3",message:"è¿·ã£ãŸã‚‰è‚‰ã‚’é£Ÿã¹ã‚ˆã†ï¼",isPublic:!0,createdAt:new Date(Date.now()-10080*60*1e3).toISOString(),userId:"user3",likes:15,replies:[{id:"r3",messageId:"p3",userId:"user4",replyText:"ãã®é€šã‚Šã§ã™ï¼",createdAt:new Date(Date.now()-8640*60*1e3).toISOString()}],userLiked:!1},{id:"m1",message:"ã‚«ãƒ¼ãƒ‹ãƒœã‚¢ãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚’å§‹ã‚ã‚‹ã‚ãªãŸã‚’å¿œæ´ã—ã¦ã„ã¾ã™ï¼ä¸€ç·’ã«å¥åº·ãªä½“ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼",isPublic:!0,createdAt:new Date(Date.now()-7200*60*1e3).toISOString(),userId:"local",likes:12,replies:[{id:"r1",messageId:"m1",userId:"user2",replyText:"ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼é ‘å¼µã‚Šã¾ã™ï¼",createdAt:new Date(Date.now()-5760*60*1e3).toISOString()}],userLiked:!1}];j(i),F(d);return}const{data:{user:s}}=await n.auth.getUser();if(!s)return;const{data:a,error:r}=await n.from("gifts").select("id, message, is_public, created_at").eq("user_id",s.id).not("message","is",null).order("created_at",{ascending:!1});r&&T(r,{action:"loadMessages",type:"myMessages"});const o=(a||[]).map(i=>({id:i.id,message:i.message||"",isPublic:i.is_public!==void 0?i.is_public:!0,createdAt:i.created_at||new Date().toISOString(),userId:s.id}));j(o);const{data:_,error:p}=await n.from("gifts").select("id, message, is_public, created_at, user_id").not("message","is",null).order("created_at",{ascending:!1}).limit(50);p&&T(p,{action:"loadMessages",type:"publicMessages"});const S=s?.id||"",P=await Promise.all((_||[]).filter(i=>i.is_public===void 0||i.is_public===!0).map(async i=>{const{count:d}=await n.from("gift_likes").select("*",{count:"exact",head:!0}).eq("gift_id",i.id),{data:A}=await n.from("gift_likes").select("id").eq("gift_id",i.id).eq("user_id",S).single(),{data:L}=await n.from("gift_replies").select("*").eq("message_id",i.id).order("created_at",{ascending:!0}),C=(L||[]).map(f=>({id:f.id,messageId:f.message_id,userId:f.user_id,replyText:f.reply_text,createdAt:f.created_at}));return{id:i.id,message:i.message||"",isPublic:!0,createdAt:i.created_at||new Date().toISOString(),userId:i.user_id||"",likes:d||0,replies:C,userLiked:!!A}}));F(P)}catch{}},y=()=>b==="amount"?u:Math.round(N*D),z=async()=>{if(I)return;if(y()<=0){alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return}$(!0);try{alert("æ±ºæ¸ˆæ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚");return}catch(a){const r=V(a);alert(`${t("common.error")}: ${r}`)}finally{$(!1)}};return e.jsx("div",{className:"gift-screen-container",children:e.jsxs("div",{className:"gift-screen-content",children:[e.jsxs("div",{className:"screen-header",children:[e.jsx("button",{className:"back-button",onClick:K,"aria-label":t("common.back"),children:"â†"}),e.jsx("h1",{className:"screen-header-title",children:t("gift.title")})]}),e.jsxs("div",{className:"gift-screen-section",children:[e.jsx("h2",{className:"gift-screen-subtitle",children:t("gift.subtitle")}),e.jsx("p",{className:"gift-screen-description",children:t("gift.description")}),h&&e.jsxs("div",{className:"gift-status-card",children:[e.jsx("h3",{className:"gift-status-title",children:t("gift.currentStatus")}),e.jsxs("div",{className:"gift-status-item",children:[e.jsx("span",{className:"gift-status-label",children:t("gift.totalAmount")}),e.jsxs("span",{className:"gift-status-value",children:["Â¥",h.totalAmount.toLocaleString()]})]}),e.jsxs("div",{className:"gift-status-item",children:[e.jsx("span",{className:"gift-status-label",children:t("gift.newUsers")}),e.jsxs("span",{className:"gift-status-value",children:[h.newUserCount,t("gift.people")]})]}),e.jsxs("div",{className:"gift-status-item",children:[e.jsx("span",{className:"gift-status-label",children:t("gift.discountPerUser")}),e.jsxs("span",{className:"gift-status-value",children:[t("gift.currency"),h.discountPerUser.toLocaleString(),t("gift.perPerson")]})]})]}),e.jsxs("div",{className:"gift-purchase-mode-section",children:[e.jsxs("div",{className:"gift-mode-toggle",children:[e.jsx("button",{className:`gift-mode-button ${b==="amount"?"active":""}`,onClick:()=>Y("amount"),children:t("gift.modeAmount")}),e.jsx("button",{className:`gift-mode-button ${b==="people"?"active":""}`,onClick:()=>Y("people"),children:t("gift.modePeople")})]}),b==="people"?e.jsxs("div",{className:"gift-people-input-section",children:[e.jsx("label",{className:"gift-people-label",children:t("gift.peopleLabel")}),e.jsx("input",{type:"number",className:"gift-people-input",value:N,onChange:s=>{const a=parseFloat(s.target.value)||.1;B(Math.max(.1,a))},min:"0.1",step:"0.1"}),e.jsxs("p",{className:"gift-people-hint",children:[t("gift.peopleHint")," ",N.toFixed(1),t("gift.amountPeopleEquivalent")," = ",t("gift.currency"),Math.round(N*D).toLocaleString()]})]}):e.jsxs("div",{className:"gift-amount-input-section",children:[e.jsx("label",{className:"gift-amount-label",children:t("gift.amountLabel")}),e.jsx("input",{type:"number",className:"gift-amount-input",value:u||"",onChange:s=>{const a=s.target.value===""?0:parseInt(s.target.value)||0;R(a)},onBlur:s=>{(u===0||u<1)&&R(1350)},min:"1",step:"1",placeholder:"1350"}),e.jsxs("p",{className:"gift-amount-hint",children:[t("gift.amountHint"),u>0&&e.jsxs("span",{className:"gift-amount-people-equivalent",children:["ï¼ˆç´„ ",(u/D).toFixed(1),t("gift.amountPeopleEquivalent"),"ï¼‰"]})]})]}),e.jsx("div",{className:"gift-purchase-summary",children:e.jsxs("p",{className:"gift-purchase-amount",children:[t("gift.total"),": ",t("gift.currency"),y().toLocaleString()]})})]}),e.jsxs("div",{className:"gift-message-section",children:[e.jsx("label",{className:"gift-message-label",children:t("gift.messageLabel")}),e.jsx("textarea",{className:"gift-message-input",value:w,onChange:s=>U(s.target.value),placeholder:t("gift.messagePlaceholder"),maxLength:200,rows:4}),e.jsx("div",{className:"gift-message-privacy",children:e.jsxs("label",{className:"gift-message-privacy-label",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:s=>Z(s.target.checked)}),e.jsxs("span",{children:[t("gift.messagePrivacy"),":"," ",t(v?"gift.messagePublic":"gift.messagePrivate")]})]})})]}),e.jsx("button",{className:"gift-purchase-button",onClick:z,disabled:I||y()<=0,children:I?t("common.loading"):`${t("gift.currency")}${y().toLocaleString()} ${t("gift.sendGift")}`}),e.jsx("p",{className:"gift-purchase-note",children:t("gift.purchaseNote")}),e.jsx("button",{className:"gift-view-messages-button",onClick:()=>G(!E),children:t("gift.viewPastMessages")}),E&&e.jsxs("div",{className:"gift-messages-modal",children:[e.jsxs("div",{className:"gift-messages-header",children:[e.jsx("h2",{children:t("gift.viewPastMessages")}),e.jsx("button",{className:"gift-messages-close-button-header",onClick:()=>G(!1),"aria-label":t("common.close"),children:"Ã—"})]}),e.jsxs("div",{className:"gift-messages-content",children:[e.jsx("h3",{children:t("gift.myMessages")}),t("gift.myMessagesDescription")&&e.jsx("p",{className:"gift-messages-description",children:t("gift.myMessagesDescription")}),x.length===0?e.jsx("p",{children:t("gift.noMessages")}):e.jsx("div",{className:"gift-messages-list",children:x.map(s=>e.jsxs("div",{className:"gift-message-item",children:[e.jsx("p",{children:s.message}),e.jsxs("div",{className:"gift-message-actions",children:[e.jsxs("button",{className:`gift-message-like-button ${s.userLiked?"liked":""}`,onClick:async()=>{const a=x.map(r=>r.id===s.id?{...r,likes:(r.likes||0)+(r.userLiked?-1:1),userLiked:!r.userLiked}:r);j(a)},children:[s.userLiked?"â¤ï¸":"ðŸ¤"," ",s.likes||0]}),e.jsxs("button",{className:"gift-message-reply-button",onClick:()=>{g(s.id),c("")},children:["ðŸ’¬ ",t("gift.reply")," ",s.replies&&s.replies.length>0&&`(${s.replies.length})`]})]}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"gift-message-replies",children:s.replies.map(a=>e.jsxs("div",{className:"gift-reply-item",children:[e.jsx("p",{children:a.replyText}),e.jsx("span",{className:"gift-reply-meta",children:new Date(a.createdAt).toLocaleDateString()})]},a.id))}),H===s.id&&e.jsxs("div",{className:"gift-reply-input",children:[e.jsx("textarea",{value:m,onChange:a=>c(a.target.value),placeholder:t("gift.replyPlaceholder"),rows:2}),e.jsxs("div",{className:"gift-reply-actions",children:[e.jsx("button",{onClick:async()=>{const a={id:Date.now().toString(),messageId:s.id,userId:"current-user",replyText:m.trim(),createdAt:new Date().toISOString()},r=x.map(o=>o.id===s.id?{...o,replies:[...o.replies||[],a]}:o);j(r),g(null),c("")},disabled:!m.trim(),children:t("common.send")}),e.jsx("button",{onClick:()=>{g(null),c("")},children:t("common.cancel")})]})]}),e.jsxs("span",{className:"gift-message-meta",children:[s.isPublic?t("gift.messagePublic"):t("gift.messagePrivate")," â€¢"," ",new Date(s.createdAt).toLocaleDateString()]})]},s.id))}),e.jsx("h3",{style:{marginTop:"2rem"},children:t("gift.communityMessages")}),t("gift.communityMessagesDescription")&&e.jsx("p",{className:"gift-messages-description",children:t("gift.communityMessagesDescription")}),q.length===0?e.jsx("p",{children:t("gift.noMessages")}):e.jsx("div",{className:"gift-messages-list",children:q.map(s=>e.jsxs("div",{className:"gift-message-item",children:[e.jsx("p",{children:s.message}),e.jsxs("div",{className:"gift-message-actions",children:[e.jsxs("button",{className:`gift-message-like-button ${s.userLiked?"liked":""}`,onClick:async()=>{{alert("ã„ã„ã­æ©Ÿèƒ½ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");return}},children:[s.userLiked?"â¤ï¸":"ðŸ¤"," ",s.likes||0]}),e.jsxs("button",{className:"gift-message-reply-button",onClick:()=>{g(s.id),c("")},children:["ðŸ’¬ ",t("gift.reply")," ",s.replies&&s.replies.length>0&&`(${s.replies.length})`]})]}),s.replies&&s.replies.length>0&&e.jsx("div",{className:"gift-message-replies",children:s.replies.map(a=>e.jsxs("div",{className:"gift-reply-item",children:[e.jsx("p",{children:a.replyText}),e.jsx("span",{className:"gift-reply-meta",children:new Date(a.createdAt).toLocaleDateString()})]},a.id))}),H===s.id&&e.jsxs("div",{className:"gift-reply-input",children:[e.jsx("textarea",{value:m,onChange:a=>c(a.target.value),placeholder:t("gift.replyPlaceholder"),rows:2}),e.jsxs("div",{className:"gift-reply-actions",children:[e.jsx("button",{onClick:async()=>{const{data:{user:a}}=await n.auth.getUser();if(!a){alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");return}try{await n.from("gift_replies").insert({message_id:s.id,user_id:a.id,reply_text:m.trim()}),M(),g(null),c("")}catch(r){T(r,{messageId:s.id}),alert("è¿”ä¿¡ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ")}},disabled:!m.trim(),children:t("common.send")}),e.jsx("button",{onClick:()=>{g(null),c("")},children:t("common.cancel")})]})]}),e.jsx("span",{className:"gift-message-meta",children:new Date(s.createdAt).toLocaleDateString()})]},s.id))})]})]})]})]})})}export{te as default};
