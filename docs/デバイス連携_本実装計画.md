# デバイス連携 本実装計画

> 体重計・体脂肪計の直接 API 連携を「これ以上することがない」状態まで実装するための計画。RULES.md 2.3 に基づき「実装」は完了時のみ使う。

**リリース時**: 連携系は一旦なし。審査を出している間に実装する。

---

## 現状

- **導線**: 日記の🔗 → 健康デバイス画面。対応済み。
- **健康デバイス画面**: 手動入力（歩数・心拍・活動時間・消費カロリー）＋ Google Fit 取得（API 未接続のため null）。体重・体脂肪は未対応。
- **体重計・体脂肪計 API**: Withings / タニタ / Health Connect 等は未対応。

---

## 目標

1. **体重・体脂肪を日記と連携**: デバイスから取得した体重・体脂肪をその日の日記（DailyLog.status）に反映。タニタ等で体重登録時は体脂肪も登録済みに（再連携不要）。
2. **Withings API**: OAuth 2.0 → アクセストークン取得 → Measure API で体重・体脂肪取得。Web で実装可能。
3. **タニタ**: Health Planet API または My Tanita 経由。Withings 完了後に検討。
4. **Health Connect / HealthKit**: ネイティブアプリ（Capacitor）でプラグイン利用。Web では不可。

---

## 実装ステップ

### Phase 1: データと UI の拡張（判断不要・実施済み）

- [x] `HealthData` に `weight`, `bodyFatPercentage` を追加
- [x] HealthDeviceScreen に体重・体脂肪の入力欄を追加
- [x] 保存時に今日の日記（DailyLog）に weight/bodyFat を反映（日記の status と top-level の両方）
- [x] Withings 用サービス骨格（`src/utils/withingsService.ts`）: 認証 URL 生成・token 交換・Measure 取得のプレースホルダー
- [x] 健康デバイス画面に「Withings と連携」ボタン追加（認証 URL へリダイレクト）
- [x] Supabase Edge Function `withings-callback`: code 受け取り・token 交換まで実装（DB 保存は TODO）

### Phase 2: Withings API 接続（本実装）

1. **Withings Developer 登録**: https://developer.withings.com/ でアプリ作成、callback URL を設定（要 HTTPS）。
2. **OAuth フロー**: 認証 URL 発行 → ユーザーが Withings で許可 → callback で code 取得 → 30 秒以内に token 交換。アクセストークン 3h、リフレッシュトークン 1 年。
3. **バックエンド**: token 交換と Measure API は **サーバー側**で実施（client_secret を隠すため）。Supabase Edge Function または別 API で callback を受け、token 保存・Measure 取得を実装。
4. **フロント**: 「Withings と連携」ボタン → 認証 URL へリダイレクト。連携後は「体重・体脂肪を取得」で Measure API を呼び（自サーバー経由）、取得値を HealthData と日記に反映。

### Phase 3: タニタ・その他（Withings 完了後）

- タニタ: Health Planet API または My Tanita 連携を調査。
- Health Connect / HealthKit: Capacitor アプリでプラグインを利用する場合は別タスク。

---

## 参照

- Withings OAuth: https://developer.withings.com/developer-guide/v3/integration-guide/public-health-data-api/get-access/oauth-authorization-url
- 決定の背景: docs/決定の背景_2026-02-03.md（体重計連携）
- 用語: docs/用語_実装の定義と表記一覧.md

---

**更新**: 2026-02-03
