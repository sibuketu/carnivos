# 認証機能 要件定義書

> **作成日**: 2026-02-01
> **目的**: リリース必須の認証・ログイン機能の完全な要件定義
> **対象実装者**: Antigravity（実装）/ Claude Code（レビュー・サポート）

---

## 📋 目次

1. [概要](#概要)
2. [機能要件](#機能要件)
3. [UI/UX仕様](#uiux仕様)
4. [セキュリティ要件](#セキュリティ要件)
5. [データ構造](#データ構造)
6. [エラーハンドリング](#エラーハンドリング)
7. [テスト要件](#テスト要件)
8. [参考アプリ](#参考アプリ)
9. [実装チェックリスト](#実装チェックリスト)

---

## 概要

### 目的
- リリース要件を満たすための認証・ログイン機能の実装
- ユーザーデータの安全な管理
- シームレスなユーザー体験の提供

### スコープ
- ✅ ユーザー登録（メール/パスワード）
- ✅ ログイン/ログアウト
- ✅ パスワードリセット
- ✅ セッション管理
- ✅ ゲストモード（ローカルストレージのみ）
- ❌ ソーシャルログイン（Google、Apple）→ 将来実装

### 技術スタック
- **認証プロバイダー**: Supabase Auth
- **UI フレームワーク**: React + TypeScript
- **状態管理**: React Context API
- **ストレージ**: Supabase Database + LocalStorage（ゲストモード）

---

## 機能要件

### 1. ユーザー登録

#### 1.1. 入力フィールド
| フィールド | 型 | 必須 | バリデーション |
|:---:|:---:|:---:|:---|
| メールアドレス | String | ✅ | RFC 5322準拠、最大254文字 |
| パスワード | String | ✅ | 最低8文字、英数字+記号を1つ以上含む |
| パスワード（確認） | String | ✅ | パスワードと一致 |

#### 1.2. 処理フロー
```
ユーザー入力
  ↓
クライアント側バリデーション
  ↓
Supabase Auth API (signUp)
  ↓
メール認証リンク送信
  ↓
ユーザーがメールリンクをクリック
  ↓
認証完了 → ログイン状態
```

#### 1.3. 成功時の挙動
- ✅ トースト表示: 「登録完了！メールを確認してください」
- ✅ メール確認画面に遷移
- ✅ バックグラウンドでユーザープロファイル作成（Supabase Database）

#### 1.4. エラー時の挙動
| エラー | 表示メッセージ | アクション |
|:---|:---|:---|
| メール重複 | 「このメールアドレスは既に登録されています」 | ログイン画面へのリンク表示 |
| ネットワークエラー | 「接続エラー。もう一度お試しください」 | リトライボタン表示 |
| バリデーションエラー | 「パスワードは8文字以上、英数字+記号を含めてください」 | 入力フィールドにエラー表示 |

---

### 2. ログイン

#### 2.1. 入力フィールド
| フィールド | 型 | 必須 | バリデーション |
|:---:|:---:|:---:|:---|
| メールアドレス | String | ✅ | RFC 5322準拠 |
| パスワード | String | ✅ | 最低1文字 |

#### 2.2. 処理フロー
```
ユーザー入力
  ↓
クライアント側バリデーション
  ↓
Supabase Auth API (signInWithPassword)
  ↓
トークン取得（access_token, refresh_token）
  ↓
ローカルストレージに保存
  ↓
ユーザープロファイル取得
  ↓
ホーム画面に遷移
```

#### 2.3. 成功時の挙動
- ✅ トースト表示: 「ログインしました」
- ✅ ホーム画面に即座に遷移
- ✅ ローカルストレージのデータをSupabaseに同期（バックグラウンド）

#### 2.4. エラー時の挙動
| エラー | 表示メッセージ | アクション |
|:---|:---|:---|
| 認証失敗 | 「メールアドレスまたはパスワードが正しくありません」 | パスワードリセットリンク表示 |
| メール未確認 | 「メールアドレスを確認してください」 | 再送信ボタン表示 |
| ネットワークエラー | 「接続エラー。もう一度お試しください」 | リトライボタン表示 |

---

### 3. パスワードリセット

#### 3.1. 入力フィールド
| フィールド | 型 | 必須 | バリデーション |
|:---:|:---:|:---:|:---|
| メールアドレス | String | ✅ | RFC 5322準拠 |

#### 3.2. 処理フロー
```
ユーザー入力（メールアドレス）
  ↓
Supabase Auth API (resetPasswordForEmail)
  ↓
パスワードリセットリンク送信
  ↓
ユーザーがメールリンクをクリック
  ↓
新しいパスワード入力画面に遷移
  ↓
パスワード更新 → ログイン状態
```

#### 3.3. 成功時の挙動
- ✅ トースト表示: 「パスワードリセットメールを送信しました」
- ✅ ログイン画面に戻る

#### 3.4. エラー時の挙動
| エラー | 表示メッセージ | アクション |
|:---|:---|:---|
| メール未登録 | 「このメールアドレスは登録されていません」（セキュリティ上、成功と同じメッセージを表示） | なし |
| ネットワークエラー | 「接続エラー。もう一度お試しください」 | リトライボタン表示 |

---

### 4. セッション管理

#### 4.1. トークン管理
- **アクセストークン**: 1時間有効
- **リフレッシュトークン**: 7日間有効（または永続）
- **保存場所**: LocalStorage（Supabase SDK が自動管理）

#### 4.2. セッション自動更新
```
アプリ起動時
  ↓
Supabase Auth.getSession()
  ↓
トークン有効性チェック
  ↓
有効 → ユーザー情報取得 → ホーム画面
  ↓
無効 → リフレッシュトークンで更新試行
  ↓
成功 → ユーザー情報取得 → ホーム画面
  ↓
失敗 → ログイン画面
```

#### 4.3. セッション期限切れ時の挙動
- ✅ トースト表示: 「セッションが期限切れです。再度ログインしてください」
- ✅ ログイン画面に遷移
- ✅ ローカルデータは保持（次回ログイン時に同期）

---

### 5. ゲストモード

#### 5.1. 目的
- アカウント作成前にアプリを試用できる
- ローカルストレージのみで動作
- いつでもアカウント作成可能

#### 5.2. データ管理
- **保存場所**: LocalStorage のみ
- **データ**: 食事記録、体重記録、設定等
- **制限**: クラウド同期なし、デバイス間同期なし

#### 5.3. アカウント作成への移行
```
ゲストモード中
  ↓
「アカウント作成」ボタンをクリック
  ↓
登録画面に遷移
  ↓
ユーザー登録完了
  ↓
ローカルデータを自動的にSupabaseに移行
  ↓
完了メッセージ表示
```

---

## UI/UX仕様

### 1. 画面一覧

#### 1.1. ログイン画面 (`/auth/login`)
```
┌─────────────────────────────────┐
│   CarnivOS ロゴ                  │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Email                    │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Password                 │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│                                  │
│   [パスワードを忘れた方]           │
│                                  │
│   ┏━━━━━━━━━━━━━━━━━━━━━━┓     │
│   ┃   ログイン              ┃     │
│   ┗━━━━━━━━━━━━━━━━━━━━━━┛     │
│                                  │
│   アカウントをお持ちでない方       │
│   [新規登録]                      │
│                                  │
│   または                         │
│   [ゲストとして試す]               │
└─────────────────────────────────┘
```

#### 1.2. ユーザー登録画面 (`/auth/register`)
```
┌─────────────────────────────────┐
│   CarnivOS ロゴ                  │
│   新規登録                       │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Email                    │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Password                 │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   最低8文字、英数字+記号           │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Password (確認)          │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│                                  │
│   ┏━━━━━━━━━━━━━━━━━━━━━━┓     │
│   ┃   登録                  ┃     │
│   ┗━━━━━━━━━━━━━━━━━━━━━━┛     │
│                                  │
│   既にアカウントをお持ちの方       │
│   [ログイン]                      │
└─────────────────────────────────┘
```

#### 1.3. パスワードリセット画面 (`/auth/reset-password`)
```
┌─────────────────────────────────┐
│   CarnivOS ロゴ                  │
│   パスワードリセット               │
│                                  │
│   登録したメールアドレスを入力して │
│   ください。パスワードリセット用の │
│   リンクを送信します。            │
│                                  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│   │ Email                    │  │
│   ━━━━━━━━━━━━━━━━━━━━━━━━     │
│                                  │
│   ┏━━━━━━━━━━━━━━━━━━━━━━┓     │
│   ┃   送信                  ┃     │
│   ┗━━━━━━━━━━━━━━━━━━━━━━┛     │
│                                  │
│   [ログイン画面に戻る]             │
└─────────────────────────────────┘
```

### 2. 画面遷移フロー

```
[アプリ起動]
    ↓
[セッションチェック]
    ↓
  有効？
    ├─ Yes → [ホーム画面]
    └─ No  → [ログイン画面]
                ↓
              選択肢
                ├─ [ログイン] → 成功 → [ホーム画面]
                ├─ [新規登録] → [登録画面] → [メール確認画面]
                ├─ [パスワードリセット] → [リセット画面] → [ログイン画面]
                └─ [ゲストとして試す] → [ホーム画面（ゲストモード）]
```

### 3. デザイン参考

**既存アプリから盗むべきUX**:
1. **MyFitnessPal**: シンプルな2フィールドログイン、ソーシャルログインボタン配置
2. **Noom**: 親しみやすいコピー（「さあ、始めましょう！」）、進捗バー表示
3. **iOS設定アプリ**: ミニマルなフォームデザイン、明確なエラー表示

**カーニボア視点でのUX最適化**:
- ❌ 不要な情報入力（生年月日、性別等）は登録時に聞かない → オンボーディングで聞く
- ✅ パスワード表示/非表示ボタン（目のアイコン）
- ✅ エンターキーでログイン実行
- ✅ ローディング中はボタンを無効化（二重送信防止）

---

## セキュリティ要件

### 1. パスワード要件
- **最低文字数**: 8文字
- **文字種**: 英数字+記号を最低1つ含む
- **禁止パスワード**: `password`, `12345678`, `carnivore`, `primallogic` 等の一般的なパスワード

### 2. トークン管理
- **保存場所**: LocalStorage（Supabase SDK が自動管理）
- **暗号化**: Supabase が自動的に暗号化
- **セッション期限**: アクセストークン1時間、リフレッシュトークン7日間

### 3. CSRF対策
- Supabase Auth が自動的にCSRF対策を実施
- カスタムヘッダー（`X-Client-Info`）で追加保護

### 4. XSS対策
- React のデフォルトエスケープを活用
- `dangerouslySetInnerHTML` は使用しない

### 5. レート制限
- Supabase Auth が自動的にレート制限を実施
- ログイン試行: 10回/時間
- パスワードリセット: 5回/時間

---

## データ構造

### 1. Supabase Tables

#### 1.1. `users` テーブル（Supabase Auth 自動生成）
| カラム | 型 | 説明 |
|:---|:---|:---|
| id | UUID | ユーザーID（主キー） |
| email | String | メールアドレス |
| created_at | Timestamp | 作成日時 |
| last_sign_in_at | Timestamp | 最終ログイン日時 |

#### 1.2. `user_profiles` テーブル（カスタム）
| カラム | 型 | 説明 |
|:---|:---|:---|
| id | UUID | プロファイルID（主キー） |
| user_id | UUID | ユーザーID（外部キー） |
| weight | Float | 体重（kg） |
| height | Float | 身長（cm） |
| activity_level | String | 活動レベル（sedentary, moderate, active） |
| diet_type | String | 食事タイプ（carnivore, keto, paleo） |
| created_at | Timestamp | 作成日時 |
| updated_at | Timestamp | 更新日時 |

#### 1.3. `food_logs` テーブル
| カラム | 型 | 説明 |
|:---|:---|:---|
| id | UUID | ログID（主キー） |
| user_id | UUID | ユーザーID（外部キー） |
| food_name | String | 食品名 |
| amount | Float | 量（g） |
| nutrients | JSONB | 栄養素データ |
| created_at | Timestamp | 作成日時 |

### 2. LocalStorage（ゲストモード）

| キー | 型 | 説明 |
|:---|:---|:---|
| `primal_logic_food_logs` | JSON Array | 食事記録 |
| `primal_logic_user_profile` | JSON Object | ユーザープロファイル |
| `primal_logic_settings` | JSON Object | アプリ設定 |

---

## エラーハンドリング

### 1. ネットワークエラー

**発生タイミング**:
- インターネット接続なし
- Supabaseサーバーダウン
- タイムアウト

**対処**:
```typescript
try {
  const { data, error } = await supabase.auth.signIn(...);
  if (error) throw error;
} catch (error) {
  if (error.message === 'Failed to fetch') {
    // ネットワークエラー
    showToast('接続エラー。インターネット接続を確認してください');
  } else {
    // その他のエラー
    showToast('エラーが発生しました。もう一度お試しください');
  }
}
```

### 2. バリデーションエラー

**クライアント側バリデーション**:
```typescript
const validateEmail = (email: string): boolean => {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
};

const validatePassword = (password: string): boolean => {
  return password.length >= 8 && /[a-zA-Z]/.test(password) && /[0-9]/.test(password);
};
```

**エラー表示**:
- 入力フィールドの下に赤文字でエラーメッセージ
- ボタンを無効化（グレーアウト）

### 3. 認証エラー

| エラーコード | エラーメッセージ | ユーザー向けメッセージ |
|:---|:---|:---|
| `invalid_credentials` | Invalid login credentials | メールアドレスまたはパスワードが正しくありません |
| `email_not_confirmed` | Email not confirmed | メールアドレスを確認してください |
| `user_already_exists` | User already registered | このメールアドレスは既に登録されています |

---

## テスト要件

### 1. E2Eテスト（Playwright）

#### 1.1. ユーザー登録フロー
```typescript
test('ユーザー登録フロー', async ({ page }) => {
  await page.goto('/auth/register');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'TestPassword123!');
  await page.fill('input[name="confirmPassword"]', 'TestPassword123!');
  await page.click('button[type="submit"]');
  await expect(page.locator('.toast')).toContainText('登録完了');
});
```

#### 1.2. ログインフロー
```typescript
test('ログインフロー', async ({ page }) => {
  await page.goto('/auth/login');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.fill('input[name="password"]', 'TestPassword123!');
  await page.click('button[type="submit"]');
  await expect(page).toHaveURL('/home');
  await expect(page.locator('.toast')).toContainText('ログインしました');
});
```

#### 1.3. パスワードリセットフロー
```typescript
test('パスワードリセットフロー', async ({ page }) => {
  await page.goto('/auth/reset-password');
  await page.fill('input[name="email"]', 'test@example.com');
  await page.click('button[type="submit"]');
  await expect(page.locator('.toast')).toContainText('パスワードリセットメールを送信しました');
});
```

### 2. ユニットテスト

#### 2.1. バリデーション関数
```typescript
describe('validateEmail', () => {
  it('有効なメールアドレス', () => {
    expect(validateEmail('test@example.com')).toBe(true);
  });
  it('無効なメールアドレス', () => {
    expect(validateEmail('invalid')).toBe(false);
  });
});

describe('validatePassword', () => {
  it('有効なパスワード', () => {
    expect(validatePassword('TestPassword123!')).toBe(true);
  });
  it('短すぎるパスワード', () => {
    expect(validatePassword('Test1!')).toBe(false);
  });
});
```

---

## 参考アプリ

### 1. MyFitnessPal
**良い点**:
- シンプルな2フィールドログイン
- ソーシャルログインボタンが目立つ
- エラーメッセージが明確

**URL**: https://www.myfitnesspal.com/account/login

### 2. Noom
**良い点**:
- 親しみやすいコピー
- 進捗バー表示（登録プロセスの可視化）
- モバイルファーストデザイン

**URL**: https://www.noom.com/

### 3. Cronometer
**良い点**:
- ゲストモードが充実
- ローカルデータの移行がスムーズ
- パスワード要件が明示的

**URL**: https://cronometer.com/login/

---

## 実装チェックリスト

### フェーズ1: 基本実装（Antigravity担当）

- [ ] Supabaseプロジェクト作成
- [ ] 環境変数設定（`.env`）
- [ ] Supabase Auth設定（Email/Password有効化）
- [ ] ログイン画面UI実装
- [ ] ユーザー登録画面UI実装
- [ ] パスワードリセット画面UI実装
- [ ] 認証コンテキスト実装（`AuthContext.tsx`）
- [ ] セッション管理実装
- [ ] エラーハンドリング実装
- [ ] ゲストモード実装
- [ ] ローカルデータ移行実装

### フェーズ2: テスト（Antigravity担当）

- [ ] E2Eテスト実装（Playwright）
- [ ] ユニットテスト実装（バリデーション関数）
- [ ] 手動テスト（実機）

### フェーズ3: 最適化（Claude Code担当）

- [ ] パフォーマンス最適化
- [ ] アクセシビリティチェック
- [ ] セキュリティ監査
- [ ] コードレビュー

---

最終更新: 2026-02-01
